<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Multi-language Page</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        .lang-switch button {
            margin-right: 10px;
            padding: 6px 12px;
        }
    </style>
</head>

<body>
    <div class="lang-switch">
        <button onclick="setLanguage('en')">English</button>
        <button onclick="setLanguage('ar')">عربي</button>
        <button onclick="addDataTranslate()">🛠 Add data-translate</button>
    </div>

    <h1>Welcome to our site</h1>
    <p>Contact us for more information.</p>
    <button>Submit</button>

    <script>
        (function () {
            const allowedTags = [
                "H1", "H2", "H3", "H4", "H5", "H6",
                "P", "SPAN", "BUTTON", "A", "LABEL",
                "TH", "TD", "LI", "STRONG", "SMALL"
            ];

            const translations = {
                en: {
                    welcome_to_our_site: "Welcome to our site",
                    contact_us_for_more: "Contact us for more information.",
                    submit: "Submit"
                },
                ar: {
                    welcome_to_our_site: "مرحبًا بكم في موقعنا",
                    contact_us_for_more: "اتصل بنا لمزيد من المعلومات.",
                    submit: "إرسال"
                }
            };

            const textToKeyMap = {
                "Welcome to our site": "welcome_to_our_site",
                "Contact us for more information.": "contact_us_for_more",
                "Submit": "submit"
            };

            const usedKeys = new Set(Object.values(textToKeyMap));
            let keyCounter = 1;

            const cleanKey = (text) => {
                let key = text
                    .toLowerCase()
                    .replace(/[^a-z0-9\s]/g, "")
                    .split(/\s+/)
                    .slice(0, 3)
                    .join("_");

                if (/^[0-9]/.test(key) || !key) {
                    key = `key_${keyCounter++}`;
                }

                while (usedKeys.has(key)) {
                    key += "_" + keyCounter++;
                }

                usedKeys.add(key);
                return key;
            };

            const isValidForTranslation = (el) => {
                if (!el || !el.tagName) return false;
                if (!allowedTags.includes(el.tagName)) return false;
                if (el.hasAttribute("data-translate")) return false;
                if (["SCRIPT", "STYLE", "NOSCRIPT"].includes(el.tagName)) return false;
                if (el.baseURI && el.baseURI.startsWith("chrome-extension://")) return false;
                return true;
            };

            const autoAddDataTranslate = () => {
                const elements = document.querySelectorAll("body *");

                elements.forEach((el) => {
                    const tag = el.tagName;
                    const text = el.textContent.trim();

                    if (!isValidForTranslation(el) || !text) return;

                    if (
                        !["H1", "H2", "H3", "H4", "H5", "H6"].includes(tag) &&
                        [...el.children].some((child) => child.textContent.trim())
                    ) return;

                    let key;
                    if (textToKeyMap[text]) {
                        key = textToKeyMap[text];
                    } else {
                        key = cleanKey(text);
                        textToKeyMap[text] = key;
                        translations.en[key] = text;
                        translations.ar[key] = ""; // leave Arabic empty for now
                    }

                    el.setAttribute("data-translate", key);
                });

                console.log("✅ data-translate added.");
                console.log("👇 Copy to translations.js:");
                console.log("const translations = " + JSON.stringify(translations, null, 2) + ";");
            };

            const updateLangToggleButton = (lang) => {
                const btn = document.querySelector(".lang-switch button");
                if (!btn) return;

                if (lang === "en") {
                    btn.textContent = "عربي";
                    btn.onclick = () => window.setLanguage("ar");
                } else {
                    btn.textContent = "English";
                    btn.onclick = () => window.setLanguage("en");
                }
            };

            window.setLanguage = function (lang) {
                localStorage.setItem("selectedLanguage", lang);
                document.documentElement.setAttribute("lang", lang);
                document.documentElement.setAttribute("dir", lang === "ar" ? "rtl" : "ltr");

                const content = translations[lang];
                const elements = document.querySelectorAll("[data-translate]");

                elements.forEach((el) => {
                    const key = el.getAttribute("data-translate");
                    if (key) {
                        el.textContent = content[key] || translations.en[key] || el.textContent;
                    }
                });

                updateLangToggleButton(lang);
            };

            window.addDataTranslate = autoAddDataTranslate;

            window.onload = function () {
                autoAddDataTranslate();

                const savedLang = localStorage.getItem("selectedLanguage") || "en";
                window.setLanguage(savedLang);
            };
        })();
    </script>
</body>

</html>